;; 20211004 (c) Gunter Liszewski -- (Next: S2, desktop) 

(use-modules (gnu) (guix) (gnu system nss))
(use-service-modules desktop xorg virtualization)
(use-package-modules certs gnome
		     version-control ssh ed
                     gnupg
		     emacs emacs-xyz ratpoison suckless wm
		     xorg virtualization linux)
(operating-system
  (host-name "S2")
  (timezone "Europe/Belfast")
  (locale "en_GB.utf8")
  (keyboard-layout (keyboard-layout "gb"))
  (label (string-titlecase
	  (string-append
	   "GNU Guix: S2 with "
	   (package-name (operating-system-kernel this-operating-system)) " "
	   (package-version (operating-system-kernel this-operating-system)))))
  ;;XXX: the linux kernel for this particular machine
;;  (kernel ak3v-linux)
  (kernel-arguments (append (list "modprobe.blacklist=iwlwifi"
				  "iommu_intel=on"
				  "vfio.ids=8086:095a,10ec:8168")
			    %default-kernel-arguments))
  ;; XXX:20211004,gl temporary fix, in progress
;;  (initrd-modules (append '("sdhci_pci") %base-initrd-modules))
  ;; XXX: Accomodate the SSD drive
    (initrd-modules (append (list "mmc_block" "sdhci_pci")
			  %base-initrd-modules))
  ;;  (bootloader (bootloader-configuration
  ;;                (bootloader grub-efi-bootloader)
  ;;                (target "/boot/efi")
  ;;                (keyboard-layout keyboard-layout)))
  (bootloader (bootloader-configuration
	       (bootloader grub-bootloader)
	       (targets '("/dev/sda"))
	       (keyboard-layout keyboard-layout)
	       (timeout 3)
	       (menu-entries 
		(list (menu-entry
		       (label "The Other,still to be confirmed")
		       (linux "Linux")
		       (linux-arguments (list
					 "root=/dev/sda2"
					 "console=ttyS13"))
		       (initrd "boot/initrd.img"))
		      (menu-entry
		       (label "(operating-system-full-name or so)")
		       (linux "(operating-system-kernel-name)")
		       (linux-arguments (list
					 "root=10.128.192.51:/srv/S2"
					 "quiet"))
		       (initrd "boot/nothere.img"))))))
  (mapped-devices
   (list (mapped-device
	  (source "HyperVG11")
	  (targets (list "HyperVG11-S2" "HyperVG11-SRC1" "HyperVG11-BUILD1" "HyperVG11-media--6"))
	  (type lvm-device-mapping))))
  
  (file-systems (append
                 (list (file-system
                        (device "/dev/mapper/HyperVG11-S2")
                        (mount-point "/")
                        (type "btrfs")
			(options "subvol=@/0")
			(dependencies mapped-devices))
                       (file-system
                        (device (uuid "DEA7-9178" 'fat))
                        (mount-point "/boot/efi")
                        (type "vfat"))

		       ;; review
		       (file-system
			(device "/dev/mmcblk0p5")
			(mount-point "/home/S10")
			(type "btrfs")
			(create-mount-point? #t)
			(mount? #t))
		       ;; mmc2
		       (file-system
			(device "/dev/mmcblk2p1")
			(mount-point "/home/RASPIFIRM")
			(type "vfat")
			(create-mount-point? #t)
			(mount? #f))
		       (file-system
			(device "/dev/mmcblk2p2")
			(mount-point "/home/RASPIROOT")
			(type "ext4")
			(create-mount-point? #t)
			(mount? #f))
		       (file-system
			(device "/dev/mmcblk2p3")
			(mount-point "/home/CORE64")
			(type "ext2")
			(create-mount-point? #t)
			(mount? #f))

		       (file-system
			(device "/dev/mapper/HyperVG11-SRC1")
			(mount-point "/home/source-1")
			(type "btrfs")
			(create-mount-point? #t)
			(mount? #t)
			(dependencies mapped-devices))
		       (file-system
			(device "/dev/mapper/HyperVG11-BUILD1")
			(mount-point "/home/build-1")
			(type "btrfs")
			(create-mount-point? #t)
			(mount? #t)
			(dependencies mapped-devices))
		       (file-system
			(device "/dev/mapper/HyperVG11-media--6")
			(mount-point "/home/media-1")
			(type "btrfs")
			(create-mount-point? #t)
			(mount? #t)
			(dependencies mapped-devices)))
                 %base-file-systems))

  ;; Create this user
  (users (cons (user-account
                (name "gunter")
                (comment "Next")
                (password (crypt "password" "$6$abc"))
                (group "users")
                (supplementary-groups '("wheel" "netdev"
                                        "audio" "video")))
               %base-user-accounts))

  (hosts-file (plain-file "hosts" "
127.0.0.1     localhost S2
::1           localhost S2
10.128.192.1  localhost S2
10.128.192.51 pi02
10.128.192.50 airnine
192.168.43.49 gw
192.168.43.51 pi02
192.168.43.11 pixma
192.168.43.10 ipad-03
192.168.43.6  ipad
192.168.43.3  pixi-4
185.157.233.143 m2"))
		
  ;; System-wide packages
  (packages (append (list
                     ratpoison i3-wm i3status dmenu
                     emacs emacs-exwm emacs-desktop-environment
                     xterm
                     ;; for HTTPS access
                     nss-certs
                     ;; for user mounts
                     ;; gvfs
		     alsa-utils
		     git openssh-sans-x ed
                     gnupg pinentry-tty
		     qemu)
                    %base-packages))

  ;; Add GNOME and Xfce---we can choose at the log-in screen
  ;; by clicking the gear.  Use the "desktop" services, which
  ;; include the X11 log-in service, networking with
  ;; NetworkManager, and more.
  (services (append
	     (list (service gnome-desktop-service-type)
                   (service xfce-desktop-service-type)
		   (set-xorg-configuration
		    (xorg-configuration
		     (keyboard-layout keyboard-layout)))
		   (service hurd-vm-service-type
			    (hurd-vm-configuration
			     (id 1)
			     ;; (image "/srv/Ha-1/store/Ha-1.img")
			     ;; (options '())
			     (disk-size (* 5000 (expt 2 20)))
			     (memory-size 1024))))
            %desktop-services))

  ;; Allow resolution of '.local' host names with mDNS.
  (name-service-switch %mdns-host-lookup-nss))
