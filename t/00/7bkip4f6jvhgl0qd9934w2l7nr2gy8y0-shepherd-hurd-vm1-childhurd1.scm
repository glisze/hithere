(eval-when (expand load eval) (let ((extensions (quote ())) (prepend (lambda (items lst) (let loop ((items items) (lst lst)) (if (null? items) lst (loop (cdr items) (cons (car items) (delete (car items) lst)))))))) (set! %load-path (prepend (cons "/gnu/store/zch3waxqz22labzjcslmp26vl6ij4hc9-module-import" (map (lambda (extension) (string-append extension "/share/guile/site/" (effective-version))) extensions)) %load-path)) (set! %load-compiled-path (prepend (cons "/gnu/store/r04c85djiqib7k8w9yib17wjkzgbk5sh-module-import-compiled" (map (lambda (extension) (string-append extension "/lib/guile/" (effective-version) "/site-ccache")) extensions)) %load-compiled-path))))(begin (use-modules (gnu build secret-service) (guix build utils) (shepherd service) (oop goops) ((guix build utils) #:hide (delete)) (guix build syscalls)) (make <service> #:docstring (quote "Run the Hurd in a Virtual Machine: a Childhurd.") #:provides (quote (hurd-vm1 childhurd1)) #:requires (quote (loopback networking user-processes)) #:one-shot? (quote #f) #:respawn? (quote #t) #:start (lambda () (let ((pid (fork+exec-command (append (list "/gnu/store/7bcvg2gww1mz3cdkx1sdn51kal6vbqiq-qemu-minimal-6.2.0/bin/qemu-system-i386" "-m" (number->string 1024) "--device" "rtl8139,netdev=net0" "--netdev" "user,id=net0,hostfwd=tcp:127.0.0.1:12004-:1004,hostfwd=tcp:127.0.0.1:11022-:2222,hostfwd=tcp:127.0.0.1:16900-:5900" "--hda" "/srv/Ha-1/disk-image" "--no-reboot") (if (file-exists? "/dev/kvm") (quote ("--enable-kvm")) (quote ()))) #:user "childhurd" #:group "kvm" #:environment-variables (quote ("TMPDIR=/tmp")))) (port 12004) (root "/etc/childhurd")) (catch #t (lambda _ (if (secret-service-send-secrets port root) pid (begin (kill (- pid) SIGTERM) #f))) (lambda (key . args) (kill (- pid) SIGTERM) (apply throw key args))))) #:stop (make-kill-destructor) #:actions (make-actions)))